var Ie=Object.defineProperty,Xe=Object.defineProperties;var ze=Object.getOwnPropertyDescriptors;var ue=Object.getOwnPropertySymbols;var He=Object.prototype.hasOwnProperty,Je=Object.prototype.propertyIsEnumerable;var pe=(e,t,o)=>t in e?Ie(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,U=(e,t)=>{for(var o in t||(t={}))He.call(t,o)&&pe(e,o,t[o]);if(ue)for(var o of ue(t))Je.call(t,o)&&pe(e,o,t[o]);return e},B=(e,t)=>Xe(e,ze(t));import{at as Ae,av as ye,au as he,s as le,e as Re,bG as Ye,b3 as ke,c4 as M,r as D,x as Fe,c5 as ee,be as Ee}from"./index.ab15bc04.js";import{t as Te,o as Ge,x as We,c as De,f as ge,A as de,$ as X,K as j,i as H,M as C,h as Ue,k as je,e as qe,p as Be,C as Ve}from"./CIMSymbolHelper.63cee507.js";import{q as se,k as ie,m as re}from"./enums.84480fc7.js";import{q as Ke,C as _e,B as Qe,v as Ze}from"./quantizationUtils.8032b3a5.js";import{b as Z}from"./Utils.74f9282d.js";import{L as et}from"./MaterialKey.9467dbe0.js";function tt(e){if(!e)return null;switch(e.type){case"CIMPointSymbol":{const o=e.symbolLayers;return o&&o.length===1?tt(o[0]):null}case"CIMVectorMarker":{var t;const o=e.markerGraphics;if(!o||o.length!==1)return null;const n=o[0];if(!n)return null;const i=n.geometry;if(!i)return null;const a=n.symbol;return!a||a.type!=="CIMPolygonSymbol"&&a.type!=="CIMLineSymbol"||(t=a.symbolLayers)!=null&&t.some(r=>!!r.effects)?null:{geom:i,asFill:a.type==="CIMPolygonSymbol"}}case"sdf":return{geom:e.geom,asFill:e.asFill}}return null}function ot(e){return e?e.rings?e.rings:e.paths?e.paths:e.xmin!==void 0&&e.ymin!==void 0&&e.xmax!==void 0&&e.ymax!==void 0?[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]]:null:null}function it(e){let t=1/0,o=-1/0,n=1/0,i=-1/0;for(const a of e)for(const r of a)r[0]<t&&(t=r[0]),r[0]>o&&(o=r[0]),r[1]<n&&(n=r[1]),r[1]>i&&(i=r[1]);return new Te(t,n,o-t,i-n)}function Se(e){let t=1/0,o=-1/0,n=1/0,i=-1/0;for(const a of e)for(const r of a)r[0]<t&&(t=r[0]),r[0]>o&&(o=r[0]),r[1]<n&&(n=r[1]),r[1]>i&&(i=r[1]);return[t,n,o,i]}function Me(e){return e?e.rings?Se(e.rings):e.paths?Se(e.paths):Ae(e)?[e.xmin,e.ymin,e.xmax,e.ymax]:null:null}function xe(e,t,o,n,i){const[a,r,s,l]=e;if(s<a||l<r)return[0,0,0];const u=s-a,m=l-r,p=128,f=1,c=Math.floor(.5*(.5*p-f)),y=(p-2*(c+f))/Math.max(u,m),g=Math.round(u*y)+2*c,S=Math.round(m*y)+2*c;let d=1;t&&(d=S/y/(t.ymax-t.ymin));let v=0,b=0;if(n)if(i){if(t&&o&&t.ymax-t.ymin>0){const N=(t.xmax-t.xmin)/(t.ymax-t.ymin);v=n.x/(o*N),b=n.y/o}}else v=n.x,b=n.y;return v=.5*(t.xmax+t.xmin)+v*(t.xmax-t.xmin),b=.5*(t.ymax+t.ymin)+b*(t.ymax-t.ymin),v-=a,b-=r,v*=y,b*=y,v+=c,b+=c,[d,v/g-.5,-(b/S-.5)]}function Gt(e){const t=ot(e.geom),o=it(t),n=128,i=1,a=Math.floor(.5*(.5*n-i)),r=(n-2*(a+i))/Math.max(o.width,o.height),s=Math.round(o.width*r)+2*a,l=Math.round(o.height*r)+2*a,u=[];for(const p of t)if(p&&p.length>1){const f=[];for(const c of p){let[y,g]=c;y-=o.x,g-=o.y,y*=r,g*=r,y+=a-.5,g+=a-.5,e.asFill?f.push([y,g]):f.push([Math.round(y),Math.round(g)])}if(e.asFill){const c=f.length-1;f[0][0]===f[c][0]&&f[0][1]===f[c][1]||f.push(f[0])}u.push(f)}const m=rt(u,s,l,a);return e.asFill&&nt(u,s,l,a,m),[at(m,a),s,l]}function rt(e,t,o,n){const i=t*o,a=new Array(i),r=n*n+1;for(let s=0;s<i;++s)a[s]=r;for(const s of e){const l=s.length;for(let u=1;u<l;++u){const m=s[u-1],p=s[u];let f,c,y,g;m[0]<p[0]?(f=m[0],c=p[0]):(f=p[0],c=m[0]),m[1]<p[1]?(y=m[1],g=p[1]):(y=p[1],g=m[1]);let S=Math.floor(f)-n,d=Math.floor(c)+n,v=Math.floor(y)-n,b=Math.floor(g)+n;S<0&&(S=0),d>t&&(d=t),v<0&&(v=0),b>o&&(b=o);const N=p[0]-m[0],x=p[1]-m[1],I=N*N+x*x;for(let P=S;P<d;P++)for(let O=v;O<b;O++){let k,z,L=(P-m[0])*N+(O-m[1])*x;L<0?(k=m[0],z=m[1]):L>I?(k=p[0],z=p[1]):(L/=I,k=m[0]+L*N,z=m[1]+L*x);const J=(P-k)*(P-k)+(O-z)*(O-z),F=(o-O-1)*t+P;J<a[F]&&(a[F]=J)}}}for(let s=0;s<i;++s)a[s]=Math.sqrt(a[s]);return a}function nt(e,t,o,n,i){for(const a of e){const r=a.length;for(let s=1;s<r;++s){const l=a[s-1],u=a[s];let m,p,f,c;l[0]<u[0]?(m=l[0],p=u[0]):(m=u[0],p=l[0]),l[1]<u[1]?(f=l[1],c=u[1]):(f=u[1],c=l[1]);let y=Math.floor(m),g=Math.floor(p)+1,S=Math.floor(f),d=Math.floor(c)+1;y<n&&(y=n),g>t-n&&(g=t-n),S<n&&(S=n),d>o-n&&(d=o-n);for(let v=S;v<d;++v){if(l[1]>v==u[1]>v)continue;const b=(o-v-1)*t;for(let N=y;N<g;++N)N<(u[0]-l[0])*(v-l[1])/(u[1]-l[1])+l[0]&&(i[b+N]=-i[b+N]);for(let N=n;N<y;++N)i[b+N]=-i[b+N]}}}}function at(e,t){const o=2*t,n=e.length,i=new Uint8Array(4*n);for(let a=0;a<n;++a){const r=.5-e[a]/o;Ge(r,i,4*a)}return i}const st=96/72;class ve{static executeEffects(t,o,n){const i=De(o),a=st;let r=new ge(i);for(const s of t){const l=de(s);l&&(r=l.execute(r,s,a,n))}return r}static next(t){const o=t.next();return We(o),o}static applyEffects(t,o,n){if(!t)return o;let i=new ge(o);for(const s of t){const l=de(s);l&&(i=l.execute(i,s,1,n))}let a,r=null;for(;a=i.next();)r?ye(r)?ye(a)&&r.paths.push(...a.paths):he(r)&&he(a)&&r.rings.push(...a.rings):r=a;return r}}function te(e,t,o,n,i){const a=e.referencesGeometry()&&i?lt(t,n,i):t,r=e.repurposeFeature(a);try{return e.evaluate(B(U({},o),{$feature:r}))}catch(s){return le.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",s),null}}const ne=new Map;function lt(e,t,o){const{transform:n,hasZ:i,hasM:a}=o;ne.has(t)||ne.set(t,ct(t));const r=ne.get(t)(e.geometry,n,i,a);return B(U({},e),{geometry:r})}function ct(e){const t={};switch(e){case"esriGeometryPoint":return(o,n,i,a)=>Ze(n,t,o,i,a);case"esriGeometryPolygon":return(o,n,i,a)=>Qe(n,t,o,i,a);case"esriGeometryPolyline":return(o,n,i,a)=>_e(n,t,o,i,a);case"esriGeometryMultipoint":return(o,n,i,a)=>Ke(n,t,o,i,a);default:return le.getLogger("esri.views.2d.support.arcadeOnDemand").error(new Re("mapview-arcade",`Unable to handle geometryType: ${e}`)),o=>o}}function Oe(e){const t=e.toLowerCase().split(" ").join("-");switch(t){case"serif":return"noto-serif";case"sans-serif":return"arial-unicode-ms";case"monospace":return"ubuntu-mono";case"fantasy":return"cabin-sketch";case"cursive":return"redressed";default:return t}}function Wt(e){const t=ft(e)+mt(e);return Oe(e.family)+(t.length>0?t:"-regular")}function ft(e){if(!e.weight)return"";switch(e.weight.toLowerCase()){case"bold":case"bolder":return"-bold"}return""}function mt(e){if(!e.style)return"";switch(e.style.toLowerCase()){case"italic":case"oblique":return"-italic"}return""}const Pe=le.getLogger("esri.symbols.cim.cimAnalyzer");function ce(e){switch(e){case"Butt":return ie.BUTT;case"Square":return ie.SQUARE;default:return ie.ROUND}}function fe(e){switch(e){case"Bevel":return re.BEVEL;case"Miter":return re.MITER;default:return re.ROUND}}function ut(e){switch(e){case"Left":default:return"left";case"Right":return"right";case"Center":return"center";case"Justify":return"justify"}}function pt(e){switch(e){case"Top":default:return"top";case"Center":return"middle";case"Baseline":return"baseline";case"Bottom":return"bottom"}}function yt(e){let t="",o="";if(e){const n=e.toLowerCase();n.indexOf("italic")!==-1?t="italic":n.indexOf("oblique")!==-1&&(t="oblique"),n.indexOf("bold")!==-1?o="bold":n.indexOf("light")!==-1&&(o="lighter")}return{style:t,weight:o}}function ht(e){return e.underline?"underline":e.strikethrough?"line-through":"none"}function be(e,t,o,n){let i;e[t]?i=e[t]:(i={},e[t]=i),i[o]=n}function Ne(e){const t=e.markerPlacement;return t&&t.angleToLine?se.MAP:se.SCREEN}async function Dt(e,t,o,n,i){const a=n!=null?n:[];if(!e)return a;let r,s;const l={};if(e.type!=="CIMSymbolReference")return Pe.error("Expect cim type to be 'CIMSymbolReference'"),a;if(r=e.symbol,s=e.primitiveOverrides,s){const m=[];for(const p of s){const f=p.valueExpressionInfo;if(f&&t){const c=f.expression,y=Ye(c,t.spatialReference,t.fields).then(g=>{g&&be(l,p.primitiveName,p.propertyName,g)});m.push(y)}else p.value!=null&&be(l,p.primitiveName,p.propertyName,p.value)}m.length>0&&await Promise.all(m)}const u=[];switch(Le(r,o,u),u.length>0&&await Promise.all(u),r.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":gt(r,s,l,t,a,o,i)}return a}function gt(e,t,o,n,i,a,r){if(!e)return;const s=e.symbolLayers;if(!s)return;const l=e.effects;let u;const m=X.getSize(e);e.type==="CIMPointSymbol"&&e.angleAlignment==="Map"&&(u=se.MAP);let p=s.length;for(;p--;){const f=s[p];if(!f||f.enable===!1)continue;let c;l&&l.length&&(c=[...l]);const y=f.effects;y&&y.length&&(l?c.push(...y):c=[...y]);const g=[];let S;j.findEffectOverrides(c,t,g),S=g.length>0?$t(c,g,o,n):c;const d=[];switch(j.findApplicableOverrides(f,t,d),f.type){case"CIMSolidFill":dt(f,S,o,d,n,i);break;case"CIMPictureFill":St(f,S,o,d,n,a,i);break;case"CIMHatchFill":vt(f,S,o,d,n,i);break;case"CIMGradientFill":bt(f,S,o,d,n,i);break;case"CIMSolidStroke":Nt(f,S,o,d,n,i,e.type==="CIMPolygonSymbol",m);break;case"CIMPictureStroke":Ct(f,S,o,d,n,i,e.type==="CIMPolygonSymbol",m);break;case"CIMGradientStroke":kt(f,S,o,d,n,i,e.type==="CIMPolygonSymbol",m);break;case"CIMCharacterMarker":if(ae(f,S,o,d,n,i))break;break;case"CIMPictureMarker":if(ae(f,S,o,d,n,i))break;e.type==="CIMLineSymbol"&&(u=Ne(f)),Mt(f,S,o,d,n,a,i,u,m);break;case"CIMVectorMarker":if(ae(f,S,o,d,n,i))break;e.type==="CIMLineSymbol"&&(u=Ne(f)),xt(f,S,o,d,n,i,a,u,m,r);break;default:Pe.error("Cannot analyze CIM layer",f.type)}}}function dt(e,t,o,n,i,a){const r=e.primitiveName,s=H(e.color),[l,u]=A(n,r,t,null),m=M(JSON.stringify(e)+u).toString();a.push({type:"fill",templateHash:m,materialHash:l?()=>m:m,cim:e,materialOverrides:null,colorLocked:e.colorLocked,color:h(r,o,"Color",i,s,Y),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:t})}function St(e,t,o,n,i,a,r){const s=e.primitiveName,l=e.tintColor?H(e.tintColor):{r:255,g:255,b:255,a:1},[u,m]=A(n,s,t,null),p=M(JSON.stringify(e)+m).toString(),f=M(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString();let c=C(e.scaleX);if("width"in e){const y=e.width;let g=1;const S=a.getResource(e.url);D(S)&&(g=S.width/S.height),c/=g*(e.height/y)}r.push({type:"fill",templateHash:p,materialHash:u?()=>f:f,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:t,color:h(s,o,"TintColor",i,l,Y),height:h(s,o,"Height",i,e.height),scaleX:h(s,o,"ScaleX",i,c),angle:h(s,o,"Rotation",i,C(e.rotation)),offsetX:h(s,o,"OffsetX",i,C(e.offsetX)),offsetY:h(s,o,"OffsetY",i,C(e.offsetY)),url:e.url})}function vt(e,t,o,n,i,a){const r=["Rotation","OffsetX","OffsetY"],s=n.filter(c=>c.primitiveName!==e.primitiveName&&r.indexOf(c.propertyName)===-1),l=e.primitiveName,[u,m]=A(n,l,t,null),p=M(JSON.stringify(e)+m).toString(),f=M(`${e.separation}${JSON.stringify(e.lineSymbol)}`).toString();a.push({type:"fill",templateHash:p,materialHash:u?K(f,o,s,i):f,cim:e,materialOverrides:s,colorLocked:e.colorLocked,effects:t,color:{r:255,g:255,b:255,a:1},height:h(l,o,"Separation",i,e.separation),scaleX:1,angle:h(l,o,"Rotation",i,C(e.rotation)),offsetX:h(l,o,"OffsetX",i,C(e.offsetX)),offsetY:h(l,o,"OffsetY",i,C(e.offsetY))})}function bt(e,t,o,n,i,a){const r=e.primitiveName,[s,l]=A(n,r,t,null),u=M(JSON.stringify(e)+l).toString();a.push({type:"fill",templateHash:u,materialHash:s?K(u,o,n,i):u,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:t,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1})}function Nt(e,t,o,n,i,a,r,s){const l=e.primitiveName,u=H(e.color),m=e.width!==void 0?e.width:4,p=ce(e.capStyle),f=fe(e.joinStyle),c=e.miterLimit,[y,g]=A(n,l,t,null),S=M(JSON.stringify(e)+g).toString();let d,v;if(t&&t instanceof Array&&t.length>0){const b=t[t.length-1];if(b.type==="CIMGeometricEffectDashes"&&b.lineDashEnding==="NoConstraint"&&b.offsetAlongLine===null){const N=(t=[...t]).pop();d=N.dashTemplate,v=N.scaleDash}}a.push({type:"line",templateHash:S,materialHash:y?()=>S:S,cim:e,materialOverrides:null,isOutline:r,colorLocked:e.colorLocked,effects:t,color:h(l,o,"Color",i,u,Y),width:h(l,o,"Width",i,m),cap:h(l,o,"CapStyle",i,p),join:h(l,o,"JoinStyle",i,f),miterLimit:h(l,o,"MiterLimit",i,c),referenceWidth:s,zOrder:me(e.name),dashTemplate:d,scaleDash:v})}function Ct(e,t,o,n,i,a,r,s){const l=M(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),u=e.primitiveName,m=H(e.tintColor),p=e.width!==void 0?e.width:4,f=ce(e.capStyle),c=fe(e.joinStyle),y=e.miterLimit,[g,S]=A(n,u,t,null),d=M(JSON.stringify(e)+S).toString();a.push({type:"line",templateHash:d,materialHash:g?()=>l:l,cim:e,materialOverrides:null,isOutline:r,colorLocked:e.colorLocked,effects:t,color:h(u,o,"TintColor",i,m,Y),width:h(u,o,"Width",i,p),cap:h(u,o,"CapStyle",i,f),join:h(u,o,"JoinStyle",i,c),miterLimit:h(u,o,"MiterLimit",i,y),referenceWidth:s,zOrder:me(e.name),dashTemplate:null,scaleDash:!1,url:e.url})}function kt(e,t,o,n,i,a,r,s){const l=e.primitiveName,u=e.width!==void 0?e.width:4,m=ce(e.capStyle),p=fe(e.joinStyle),f=e.miterLimit,[c,y]=A(n,l,t,null),g=M(JSON.stringify(e)+y).toString();a.push({type:"line",templateHash:g,materialHash:c?K(g,o,n,i):g,cim:e,materialOverrides:null,isOutline:r,colorLocked:e.colorLocked,effects:t,color:{r:128,g:128,b:128,a:1},width:h(l,o,"Width",i,u),cap:h(l,o,"CapStyle",i,m),join:h(l,o,"JoinStyle",i,p),miterLimit:h(l,o,"MiterLimit",i,f),referenceWidth:s,zOrder:me(e.name),dashTemplate:null,scaleDash:!1})}function ae(e,t,o,n,i,a){const r=e.markerPlacement;if(!r||r.type!=="CIMMarkerPlacementInsidePolygon")return!1;const s=r,l=["Rotation","OffsetX","OffsetY"],u=n.filter(d=>d.primitiveName!==e.primitiveName&&l.indexOf(d.propertyName)===-1),m="url"in e?e.url:null,[p,f]=A(n,s.primitiveName,t,null),c=M(JSON.stringify(e)+f).toString();let y=s.stepY,g=null,S=1;return r.shiftOddRows&&(y*=2,g=function(d){return d?2*d:0},S=.5),a.push({type:"fill",templateHash:c,materialHash:p?K(c,o,u,i):c,cim:e,materialOverrides:u,colorLocked:e.colorLocked,effects:t,color:{r:255,g:255,b:255,a:1},height:h(s.primitiveName,o,"StepY",i,y,g),scaleX:S,angle:h(s.primitiveName,o,"GridAngle",i,s.gridAngle),offsetX:h(s.primitiveName,o,"OffsetX",i,C(s.offsetX)),offsetY:h(s.primitiveName,o,"OffsetY",i,C(s.offsetY)),url:m}),!0}function Mt(e,t,o,n,i,a,r,s,l){var u;const m=e.primitiveName,p=C(e.size);let f=C(e.scaleX);const c=C(e.rotation),y=C(e.offsetX),g=C(e.offsetY),S=e.tintColor?H(e.tintColor):{r:255,g:255,b:255,a:1},d=M(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),v=we(e.markerPlacement,n,o,i),[b,N]=A(n,m,t,v),x=M(JSON.stringify(e)+N).toString(),I=(u=e.anchorPoint)!=null?u:{x:0,y:0};if("width"in e){const P=e.width;let O=1;const k=a.getResource(e.url);D(k)&&(O=k.width/k.height),f/=O*(p/P)}r.push({type:"marker",templateHash:x,materialHash:b?()=>d:d,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:!1,alignment:s,size:h(m,o,"Size",i,p),scaleX:h(m,o,"ScaleX",i,f),rotation:h(m,o,"Rotation",i,c),offsetX:h(m,o,"OffsetX",i,y),offsetY:h(m,o,"OffsetY",i,g),color:h(m,o,"TintColor",i,S,Y),anchorPoint:{x:I.x,y:-I.y},isAbsoluteAnchorPoint:e.anchorPointUnits!=="Relative",outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:e.rotateClockwise,referenceSize:l,sizeRatio:1,markerPlacement:e.markerPlacement,url:e.url})}function xt(e,t,o,n,i,a,r,s,l,u){const m=e.markerGraphics;if(!m)return;let p=0;if(e.scaleSymbolsProportionally){const c=e.frame;c&&(p=c.ymax-c.ymin)}const f=we(e.markerPlacement,n,o,i);for(const c of m)if(c){const y=c.symbol;if(!y)continue;switch(y.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":Pt(e,t,f,c,n,o,i,a,r,s,l,p,u);break;case"CIMTextSymbol":Ot(e,t,f,c,o,n,i,a,s,l,p)}}}function Ot(e,t,o,n,i,a,r,s,l,u,m){const p=[];j.findApplicableOverrides(n,a,p);const f=n.geometry;if(!("x"in f)||!("y"in f))return;const c=n.symbol,y=ht(c),g=yt(c.fontStyleName),S=Oe(c.fontFamilyName);c.font=U({family:S,decoration:y},g);const d=e.frame,v=f.x-.5*(d.xmin+d.xmax),b=f.y-.5*(d.ymin+d.ymax),N=e.size/m,x=e.primitiveName,I=C(c.height)*N,P=C(c.angle),O=C(e.offsetX)+(C(c.offsetX)+v)*N,k=C(e.offsetY)+(C(c.offsetY)+b)*N,z=H(X.getFillColor(c));let L=H(X.getStrokeColor(c)),J=X.getStrokeWidth(c);J||(L=H(X.getFillColor(c.haloSymbol)),J=c.haloSize*N);const[F,q]=A(a,x,t,o),E=JSON.stringify(e.effects)+Number(e.colorLocked)+JSON.stringify(e.anchorPoint)+e.anchorPointUnits+JSON.stringify(e.markerPlacement),R=M(JSON.stringify(n)+E+q).toString();let $=h(n.primitiveName,i,"TextString",r,n.textString,Ue,c.textCase);if($==null)return;const{fontStyleName:T}=c,G=S+(T?"-"+T.toLowerCase():"-regular"),w=G;typeof $=="string"&&$.indexOf("[")>-1&&c.fieldMap&&($=je(c.fieldMap,$,c.textCase)),s.push({type:"text",templateHash:R,materialHash:F||typeof $=="function"||$.match(/\[(.*?)\]/)?(_,oe,Q)=>w+"-"+qe($,_,oe,Q):w+"-"+M($),cim:c,materialOverrides:null,colorLocked:e.colorLocked,effects:t,alignment:l,anchorPoint:{x:e.anchorPoint?e.anchorPoint.x:0,y:e.anchorPoint?e.anchorPoint.y:0},isAbsoluteAnchorPoint:e.anchorPointUnits!=="Relative",fontName:G,decoration:y,weight:h(x,i,"Weight",r,g.weight),style:h(x,i,"Size",r,g.style),size:h(x,i,"Size",r,I),angle:h(x,i,"Rotation",r,P),offsetX:h(x,i,"OffsetX",r,O),offsetY:h(x,i,"OffsetY",r,k),horizontalAlignment:ut(c.horizontalAlignment),verticalAlignment:pt(c.verticalAlignment),text:$,color:z,outlineColor:L,outlineSize:J,referenceSize:u,sizeRatio:1,markerPlacement:o})}function Pt(e,t,o,n,i,a,r,s,l,u,m,p,f){const c=n.symbol,y=c.symbolLayers;if(!y)return;if(f)return void Ce(e,t,o,n,a,i,r,s,l,u,m,p);let g=y.length;if(It(y))return void wt(e,t,o,n,y,i,a,r,s,u,m,p);const S=ve.applyEffects(c.effects,n.geometry,l.geometryEngine);if(S)for(;g--;){const v=y[g];if(v&&v.enable!==!1)switch(v.type){case"CIMSolidFill":case"CIMSolidStroke":{var d;const b=ve.applyEffects(v.effects,S,l.geometryEngine),N=Me(b);if(!N)continue;const[x,I,P]=xe(N,e.frame,e.size,e.anchorPoint,e.anchorPointUnits!=="Relative"),O=v.type==="CIMSolidFill",k={type:"sdf",geom:b,asFill:O},z=e.primitiveName,L=(d=C(e.size))!=null?d:10,J=C(e.rotation),F=C(e.offsetX),q=C(e.offsetY),E=v.path,R=v.primitiveName,$=H(O?X.getFillColor(v):X.getStrokeColor(v)),T=O?{r:0,g:0,b:0,a:0}:H(X.getStrokeColor(v)),G=X.getStrokeWidth(v);if(!O&&!G)break;let w=!1,_="";for(const W of i)W.primitiveName!==R&&W.primitiveName!==z||(W.value!==void 0?_+=`-${W.primitiveName}-${W.propertyName}-${JSON.stringify(W.value)}`:W.valueExpressionInfo&&(w=!0));D(t)&&typeof t=="function"&&(w=!0);const oe=JSON.stringify(B(U({},e),{markerGraphics:null})),Q=M(JSON.stringify(k)+E).toString(),$e={type:"marker",templateHash:M(JSON.stringify(n)+JSON.stringify(v)+oe+_).toString(),materialHash:w?()=>Q:Q,cim:k,materialOverrides:null,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:u,anchorPoint:{x:I,y:P},isAbsoluteAnchorPoint:!1,size:h(e.primitiveName,a,"Size",r,L),rotation:h(e.primitiveName,a,"Rotation",r,J),offsetX:h(e.primitiveName,a,"OffsetX",r,F),offsetY:h(e.primitiveName,a,"OffsetY",r,q),scaleX:1,frameHeight:p,rotateClockwise:e.rotateClockwise,referenceSize:m,sizeRatio:x,color:h(R,a,"Color",r,$,Y),outlineColor:h(R,a,"Color",r,T,Y),outlineWidth:h(R,a,"Width",r,G),markerPlacement:o,path:E};s.push($e);break}default:Ce(e,t,o,n,a,i,r,s,l,u,m,p)}}}function wt(e,t,o,n,i,a,r,s,l,u,m,p){const f=n.geometry,c=i[0],y=i[1],g=Me(f);if(!g)return;const[S,d,v]=xe(g,e.frame,e.size,e.anchorPoint,e.anchorPointUnits!=="Relative"),b={type:"sdf",geom:f,asFill:!0},N=e.primitiveName,x=C(e.size),I=C(e.rotation),P=C(e.offsetX),O=C(e.offsetY),k=y.path,z=y.primitiveName,L=c.primitiveName,J=H(X.getFillColor(y)),F=H(X.getStrokeColor(c)),q=X.getStrokeWidth(c);let E=!1,R="";for(const w of a)w.primitiveName!==z&&w.primitiveName!==L&&w.primitiveName!==N||(w.value!==void 0?R+=`-${w.primitiveName}-${w.propertyName}-${JSON.stringify(w.value)}`:w.valueExpressionInfo&&(E=!0));const $=JSON.stringify(B(U({},e),{markerGraphics:null})),T=M(JSON.stringify(b)+k).toString(),G={type:"marker",templateHash:M(JSON.stringify(n)+JSON.stringify(y)+JSON.stringify(c)+$+R).toString(),materialHash:E?()=>T:T,cim:b,materialOverrides:null,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:u,anchorPoint:{x:d,y:v},isAbsoluteAnchorPoint:!1,size:h(e.primitiveName,r,"Size",s,x),rotation:h(e.primitiveName,r,"Rotation",s,I),offsetX:h(e.primitiveName,r,"OffsetX",s,P),offsetY:h(e.primitiveName,r,"OffsetY",s,O),scaleX:1,frameHeight:p,rotateClockwise:e.rotateClockwise,referenceSize:m,sizeRatio:S,color:h(z,r,"Color",s,J,Y),outlineColor:h(L,r,"Color",s,F,Y),outlineWidth:h(L,r,"Width",s,q),markerPlacement:o,path:k};l.push(G)}function Ce(e,t,o,n,i,a,r,s,l,u,m,p){const f=Lt(e,n);let c=[];const y=["Rotation","OffsetX","OffsetY"];c=a.filter(k=>k.primitiveName!==e.primitiveName||y.indexOf(k.propertyName)===-1);let g="";for(const k of a)k.value!==void 0&&(g+=`-${k.primitiveName}-${k.propertyName}-${JSON.stringify(k.value)}`);const[S,d,v]=X.getTextureAnchor(f,l),b=e.primitiveName,N=C(e.rotation),x=C(e.offsetX),I=C(e.offsetY),P=M(JSON.stringify(f)+g).toString(),O={type:"marker",templateHash:P,materialHash:c.length>0||D(t)&&typeof t=="function"?K(P,i,c,r):P,cim:f,materialOverrides:c,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:u,anchorPoint:{x:S,y:d},isAbsoluteAnchorPoint:!1,size:e.size,rotation:h(b,i,"Rotation",r,N),offsetX:h(b,i,"OffsetX",r,x),offsetY:h(b,i,"OffsetY",r,I),color:{r:255,g:255,b:255,a:1},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,scaleX:1,frameHeight:p,rotateClockwise:e.rotateClockwise,referenceSize:m,sizeRatio:v/Fe(e.size),markerPlacement:o};s.push(O)}function Lt(e,t){return{type:e.type,enable:!0,name:e.name,colorLocked:e.colorLocked,primitiveName:e.primitiveName,anchorPoint:e.anchorPoint,anchorPointUnits:e.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:e.rotateClockwise,rotation:0,size:e.size,billboardMode3D:e.billboardMode3D,depth3D:e.depth3D,frame:e.frame,markerGraphics:[t],scaleSymbolsProportionally:e.scaleSymbolsProportionally,respectFrame:e.respectFrame,clippingPath:e.clippingPath}}function me(e){if(e&&e.indexOf("Level_")===0){const t=parseInt(e.substr(6),10);if(!isNaN(t))return t}return 0}function Y(e){if(!e||e.length===0)return null;const t=new Ee(e).toRgba();return{r:t[0],g:t[1],b:t[2],a:t[3]}}function h(e,t,o,n,i,a,r){const s=t[e];if(s){const l=s[o];if(typeof l=="string"||typeof l=="number"||l instanceof Array)return a?a.call(null,l,r):l;if(l!=null&&l instanceof ee)return(u,m,p)=>{let f=te(l,u,{$view:p},n.geometryType,m);return f!==null&&a&&(f=a.call(null,f,r)),f!==null?f:i}}return i}function $t(e,t,o,n){for(const a of t)if(a.valueExpressionInfo){const r=o[a.primitiveName]&&o[a.primitiveName][a.propertyName];r instanceof ee&&(a.fn=(s,l,u)=>te(r,s,{$view:u},n.geometryType,l))}const i=a=>a&&a.charAt(0).toLowerCase()+a.substr(1);return(a,r,s)=>{for(const m of t)m.fn&&(m.value=m.fn(a,r,s));const l=[];for(let m of e){var u;const p=(u=m)==null?void 0:u.primitiveName;if(p){let f=!1;for(const c of t)if(c.primitiveName===p){const y=i(c.propertyName);c.value!=null&&c.value!==m[y]&&(f||(m=ke(m),f=!0),m[y]=c.value)}}l.push(m)}return l}}function we(e,t,o,n){const i=[];if(j.findApplicableOverrides(e,t,i),i.length===0)return e;for(const r of i)if(r.valueExpressionInfo){const s=o[r.primitiveName]&&o[r.primitiveName][r.propertyName];s instanceof ee&&(r.fn=(l,u,m)=>te(s,l,{$view:m},n.geometryType,u))}const a=r=>r&&r.charAt(0).toLowerCase()+r.substr(1);return(r,s,l)=>{for(const p of i)p.fn&&(p.value=p.fn(r,s,l));const u=ke(e),m=e.primitiveName;for(const p of i)if(p.primitiveName===m){const f=a(p.propertyName);p.value!=null&&p.value!==u[f]&&(u[f]=p.value)}return u}}function K(e,t,o,n){for(const i of o)if(i.valueExpressionInfo){const a=t[i.primitiveName]&&t[i.primitiveName][i.propertyName];a instanceof ee&&(i.fn=(r,s,l)=>te(a,r,{$view:l},n.geometryType,s))}return(i,a,r)=>{for(const s of o)s.fn&&(s.value=s.fn(i,a,r));return M(e+j.buildOverrideKey(o)).toString()}}function Ut(e,t){if(!t||t.length===0)return e;const o=JSON.parse(JSON.stringify(e));return j.applyOverrides(o,t),o}function A(e,t,o,n){let i=!1,a="";for(const r of e)r.primitiveName===t&&(r.value!==void 0?a+=`-${r.primitiveName}-${r.propertyName}-${JSON.stringify(r.value)}`:r.valueExpressionInfo&&(i=!0));return D(o)&&typeof o=="function"&&(i=!0),D(n)&&typeof n=="function"&&(i=!0),[i,a]}function Le(e,t,o){if(e&&t)switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":{const n=e.symbolLayers;if(!n)return;for(const i of n)switch(Xt(i,t,o),i.type){case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":case"CIMPictureStroke":case"CIMGradientStroke":case"CIMCharacterMarker":case"CIMPictureMarker":"url"in i&&i.url&&o.push(t.fetchResource(i.url,null));break;case"CIMVectorMarker":{const a=i.markerGraphics;if(!a)continue;for(const r of a)if(r){const s=r.symbol;s&&Le(s,t,o)}}}}}}const It=e=>e&&e.length===2&&e[0].enable&&e[1].enable&&e[0].type==="CIMSolidStroke"&&e[1].type==="CIMSolidFill"&&!e[0].effects&&!e[1].effects;let V;function Xt(e,t,o){if(!(!e.effects||D(t.geometryEngine))){if(V)return void o.push(V);Be(e.effects)&&(V=Ve(),o.push(V),V.then(n=>t.geometryEngine=n))}}const zt={marker:Z.MARKER,fill:Z.FILL,line:Z.LINE,text:Z.TEXT};class jt{constructor(t,o,n,i){const a={minScale:o==null?void 0:o.minScale,maxScale:o==null?void 0:o.maxScale},r=Ht(a);this.layers=t,this.data=o,this.hash=this._createHash()+r,this.rendererKey=n;const s={isOutline:!1,isOutlinedFill:!1,placement:null,stride:{fill:"default"},vvFlags:n};for(const l of t){const u=zt[l.type];l.materialKey=et(u,s),l.maxVVSize=i,l.scaleInfo=a,l.templateHash+=r}}get type(){return"expanded-cim"}_createHash(){let t="";for(const o of this.layers)t+=o.templateHash;return t}}function Ht(e){return e.minScale||e.maxScale?e.minScale+"-"+e.maxScale:""}export{Dt as H,ve as f,jt as l,Gt as m,Wt as n,Ut as o,tt as r,te as s};
