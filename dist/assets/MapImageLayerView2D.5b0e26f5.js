var C=Object.defineProperty,A=Object.defineProperties;var M=Object.getOwnPropertyDescriptors;var P=Object.getOwnPropertySymbols;var V=Object.prototype.hasOwnProperty,F=Object.prototype.propertyIsEnumerable;var S=(r,e,t)=>e in r?C(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,c=(r,e)=>{for(var t in e||(e={}))V.call(e,t)&&S(r,t,e[t]);if(P)for(var t of P(e))F.call(e,t)&&S(r,t,e[t]);return r},_=(r,e)=>A(r,M(e));import{Z as o,_ as m,cE as G,a0 as q,e as R,r as g,c9 as L,cK as T,s as D,d2 as N,j as O}from"./index.ab15bc04.js";import{t as Q}from"./BitmapContainer.c33a1913.js";import{f as j,u as z}from"./LayerView.00833560.js";import{r as H}from"./BaseGraphicContainer.85a2dee8.js";import{n as W}from"./HighlightGraphicContainer.28ca9904.js";import{S as k}from"./ExportStrategy.209ef5d3.js";import{c as K}from"./ExportImageParameters.5744beb6.js";import{s as Z,a as B}from"./drapedUtils.17aea368.js";import{t as J,d as X}from"./popupUtils.9c4a8a05.js";import{n as Y}from"./floorFilterUtils.98f77688.js";import{i as ee}from"./RefreshableLayerView.82b80800.js";import"./WGLContainer.7a493591.js";import"./enums.457e23f9.js";import"./pixelUtils.749c08fa.js";import"./Container.eaeadb22.js";import"./VertexArrayObject.cc747ff8.js";import"./Texture.b30343f5.js";import"./VertexElementDescriptor.0406f2d4.js";import"./enums.84480fc7.js";import"./Utils.74f9282d.js";import"./ProgramTemplate.0c38b6c3.js";import"./StyleDefinition.809d5a5e.js";import"./config.bd364997.js";import"./GeometryUtils.5ea26345.js";import"./MaterialKey.9467dbe0.js";import"./earcut.91e104de.js";import"./CIMSymbolHelper.63cee507.js";import"./BidiEngine.b9926823.js";import"./GeometryUtils.e53da643.js";import"./projectionSupport.7571f701.js";import"./json.da51edc4.js";import"./FeatureContainer.f52842b8.js";import"./TileContainer.ef410674.js";import"./visualVariablesUtils.3b95df02.js";import"./visualVariablesUtils.a0d78ec3.js";import"./Matcher.8ed3fb39.js";import"./tileUtils.3e5b6016.js";import"./TileClipper.3d33065b.js";import"./Geometry.e891c191.js";import"./ExpandedCIM.a556261b.js";import"./quantizationUtils.8032b3a5.js";import"./devEnvironmentUtils.f51567b1.js";import"./schemaUtils.322ed0ee.js";import"./createSymbolSchema.1a852330.js";import"./MD5.67d7a872.js";import"./util.672d1599.js";import"./ComputedAttributeStorage.7e9351cc.js";import"./vec3f32.8179e08f.js";import"./Bitmap.d09e4001.js";import"./sublayerUtils.845a5b20.js";const te=r=>{let e=class extends r{initialize(){this.exportImageParameters=new K({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var t;return(t=this.exportImageParameters)==null||t.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(t,a){const{layer:h}=this;if(!t)return Promise.reject(new R("mapimagelayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:h}));const l=this.get("view.scale"),y=[],f=async i=>{const p=i.minScale===0||l<=i.minScale,s=i.maxScale===0||l>=i.maxScale;if(i.visible&&p&&s){if(i.sublayers)i.sublayers.forEach(f);else if(i.popupEnabled){const d=X(i,_(c({},a),{defaultPopupTemplateEnabled:!1}));g(d)&&y.unshift({sublayer:i,popupTemplate:d})}}},E=h.sublayers.toArray().reverse().map(f);await Promise.all(E);const U=y.map(async({sublayer:i,popupTemplate:p})=>{await i.load().catch(()=>{});const s=i.createQuery(),d=g(a)?a.event:null,v=Z({renderer:i.renderer,event:d}),w=this.createFetchPopupFeaturesQueryGeometry(t,v);if(s.geometry=w,s.outFields=await J(i,p),this.layer.type==="map-image"&&"floors"in this.view){var x,I;const $=(x=this.view)==null||(I=x.floors)==null?void 0:I.clone(),u=Y($,i);g(u)&&(s.where=s.where?`(${s.where}) AND (${u})`:u)}const b=await this._loadArcadeModules(p);return b&&b.arcadeUtils.hasGeometryOperations(p)||(s.maxAllowableOffset=w.width/v),(await i.queryFeatures(s)).features});return(await L(U)).reduce((i,p)=>p.value?[...i,...p.value]:i,[]).filter(i=>i!=null)}canResume(){var t;return!!super.canResume()&&((t=this.timeExtent)==null||!t.isEmpty)}_loadArcadeModules(t){if(t.get("expressionInfos.length")||Array.isArray(t.content)&&t.content.some(a=>a.type==="expression"))return T()}};return o([m()],e.prototype,"exportImageParameters",void 0),o([m({readOnly:!0})],e.prototype,"exportImageVersion",null),o([m()],e.prototype,"layer",void 0),o([m()],e.prototype,"suspended",void 0),o([m(G)],e.prototype,"timeExtent",void 0),e=o([q("esri.views.layers.MapImageLayerView")],e),e},re=D.getLogger("esri.views.2d.layers.MapImageLayerView2D");let n=class extends te(ee(j(z))){constructor(){super(...arguments),this._highlightGraphics=new N}update(r){this.strategy.update(r).catch(e=>{O(e)||re.error(e)})}attach(){const{imageMaxWidth:r,imageMaxHeight:e,version:t}=this.layer,a=t>=10.3,h=t>=10;this._bitmapContainer=new Q,this.container.addChild(this._bitmapContainer);const l=new H({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new W(this.view.featuresTilingScheme)});this.container.addChild(l.container),this.strategy=new k({container:this._bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:r,imageMaxHeight:e,imageRotationSupported:a,imageNormalizationSupported:h,hidpi:!0}),this.handles.add(this.watch("exportImageVersion",()=>this.requestUpdate()),"exportImageVersion"),this.handles.add(this.watch("view.floors",()=>this.requestUpdate()),"view.floors"),this.requestUpdate()}detach(){this.handles.remove("exportImageVersion"),this.handles.remove("view.floors"),this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}highlight(r,e){return this._highlightGraphics.add(r),{remove:()=>{this._highlightGraphics.remove(r)}}}supportsSpatialReference(r){return this.layer.serviceSupportsSpatialReference(r)}createFetchPopupFeaturesQueryGeometry(r,e){return B(r,e,this.view)}async doRefresh(){this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(r,e,t,a){return this.layer.fetchImage(r,e,t,c({timeExtent:this.timeExtent,floors:this.view.floors},a))}};o([m()],n.prototype,"strategy",void 0),o([m()],n.prototype,"updating",void 0),n=o([q("esri.views.2d.layers.MapImageLayerView2D")],n);const et=n;export{et as default};
